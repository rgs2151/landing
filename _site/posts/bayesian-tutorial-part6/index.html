<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Bayesian Modeling - Part 6: GLM-HMMs and Advanced Sequential Modeling | Rudramani Singha</title>
<meta name="generator" content="Jekyll v4.3.4" />
<meta property="og:title" content="Bayesian Modeling - Part 6: GLM-HMMs and Advanced Sequential Modeling" />
<meta name="author" content="Rudramani Singha" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Welcome to the final part of our Bayesian modeling journey! We’ve traveled from simple balls in bags to complex mixture models and temporal dependencies. Now we’ll combine everything into the most sophisticated model in our series: Input-Dependent Markov Models, also known as GLM-HMMs or Switching Linear Regression." />
<meta property="og:description" content="Welcome to the final part of our Bayesian modeling journey! We’ve traveled from simple balls in bags to complex mixture models and temporal dependencies. Now we’ll combine everything into the most sophisticated model in our series: Input-Dependent Markov Models, also known as GLM-HMMs or Switching Linear Regression." />
<link rel="canonical" href="http://localhost:4000/~rgs2151/posts/bayesian-tutorial-part6/" />
<meta property="og:url" content="http://localhost:4000/~rgs2151/posts/bayesian-tutorial-part6/" />
<meta property="og:site_name" content="Rudramani Singha" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2025-01-20T00:00:00-05:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Bayesian Modeling - Part 6: GLM-HMMs and Advanced Sequential Modeling" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Rudramani Singha"},"dateModified":"2025-01-20T00:00:00-05:00","datePublished":"2025-01-20T00:00:00-05:00","description":"Welcome to the final part of our Bayesian modeling journey! We’ve traveled from simple balls in bags to complex mixture models and temporal dependencies. Now we’ll combine everything into the most sophisticated model in our series: Input-Dependent Markov Models, also known as GLM-HMMs or Switching Linear Regression.","headline":"Bayesian Modeling - Part 6: GLM-HMMs and Advanced Sequential Modeling","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/~rgs2151/posts/bayesian-tutorial-part6/"},"url":"http://localhost:4000/~rgs2151/posts/bayesian-tutorial-part6/"}</script>
<!-- End Jekyll SEO tag -->
<link rel="shortcut icon" type="image/x-icon" href="/~rgs2151//favicon.ico" >
  <link rel="stylesheet" href="/~rgs2151/assets/css/main.css">

  <link rel="preconnect" href="https://fonts.googleapis.com" />
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
	<link href="https://fonts.googleapis.com/css2?family=Mulish:ital,wght@0,200..1000;1,200..1000&display=swap" rel="stylesheet" />

</head>
<body>
    
    <main class="page">
      
      <nav class="nav">
    <!-- https://icons.getbootstrap.com -->
    <a class="nav__item " aria-label="Home Page" href="/~rgs2151/">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="white" xmlns="http://www.w3.org/2000/svg">
            <path stroke="white" stroke-width="0.5" d="M8.707 1.5a1 1 0 0 0-1.414 0L.646 8.146a.5.5 0 0 0 .708.708L2 8.207V13.5A1.5 1.5 0 0 0 3.5 15h9a1.5 1.5 0 0 0 1.5-1.5V8.207l.646.647a.5.5 0 0 0 .708-.708L13 5.793V2.5a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5v1.293zM13 7.207V13.5a.5.5 0 0 1-.5.5h-9a.5.5 0 0 1-.5-.5V7.207l5-5z"/>    
        </svg> 
    </a>
    
    <a class="nav__item " aria-label="Writing Page" href="/~rgs2151/posts/">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="white" xmlns="http://www.w3.org/2000/svg">
            <path stroke="white" stroke-width="0.5" d="m13.498.795.149-.149a1.207 1.207 0 1 1 1.707 1.708l-.149.148a1.5 1.5 0 0 1-.059 2.059L4.854 14.854a.5.5 0 0 1-.233.131l-4 1a.5.5 0 0 1-.606-.606l1-4a.5.5 0 0 1 .131-.232l9.642-9.642a.5.5 0 0 0-.642.056L6.854 4.854a.5.5 0 1 1-.708-.708L9.44.854A1.5 1.5 0 0 1 11.5.796a1.5 1.5 0 0 1 1.998-.001m-.644.766a.5.5 0 0 0-.707 0L1.95 11.756l-.764 3.057 3.057-.764L14.44 3.854a.5.5 0 0 0 0-.708z"/>
        </svg>
    </a>
    
    <a class="nav__item" aria-label="Resume" href="/~rgs2151/assets/resume.pdf" target="_blank">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="white" xmlns="http://www.w3.org/2000/svg">
            <path d="M5.5 7a.5.5 0 0 0 0 1h5a.5.5 0 0 0 0-1zM5 9.5a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5m0 2a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 0 1h-2a.5.5 0 0 1-.5-.5"/>
            <path d="M9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V4.5zm0 1v2A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1z"/>          
        </svg>
    </a>

</nav>

      <header class="page__header">
        
        <h1 class="page__title">Bayesian Modeling - Part 6: GLM-HMMs and Advanced Sequential Modeling</h1>
        
        <div style="height: 1rem;"></div><div class="postslist__item__date">Jan 20, 2025</div>
        
			</header>

      <div class="page__content">
        

        <div class="postcontent">
          <p>Welcome to the final part of our Bayesian modeling journey! We’ve traveled from simple balls in bags to complex mixture models and temporal dependencies. Now we’ll combine everything into the most sophisticated model in our series: <strong>Input-Dependent Markov Models</strong>, also known as <strong>GLM-HMMs</strong> or <strong>Switching Linear Regression</strong>.</p>

<p>This is where Bayesian modeling truly shines for complex, real-world sequential data with changing dynamics.</p>

<h2 id="the-conveyor-belt-factory">The Conveyor Belt Factory</h2>

<h3 id="example-conveyor-belts-in-the-color-factory">Example: Conveyor Belts in the Color Factory</h3>

<p>Imagine a <strong>factory</strong> with <strong>three conveyor belts</strong>, each handling different ball-packing operations:</p>

<ol>
  <li><strong>Belt 1 (Red Balls)</strong>:
    <ul>
      <li>On this belt, the redness of a ball ($ y $) depends positively on its weight ($ x $), so heavier balls are redder.</li>
    </ul>
  </li>
  <li><strong>Belt 2 (Blue Balls)</strong>:
    <ul>
      <li>Here, the redness depends negatively on the ball’s weight, making heavier balls bluer.</li>
    </ul>
  </li>
  <li><strong>Belt 3 (Neutral Balls)</strong>:
    <ul>
      <li>This belt doesn’t correlate much with weight, producing balls of all colors.</li>
    </ul>
  </li>
</ol>

<h3 id="the-markovian-twist">The Markovian Twist</h3>

<p>Unlike the mixture model (where balls came independently from factories), this process is sequential:</p>

<ul>
  <li>The conveyor belts operate in a <strong>Markovian sequence</strong>:
    <ul>
      <li>If the current belt is Belt 1, it’s most likely to switch to Belt 2.</li>
      <li>If the current belt is Belt 2, it tends to switch to Belt 3.</li>
      <li>If the current belt is Belt 3, it’s likely to switch back to Belt 1.</li>
    </ul>
  </li>
  <li>You observe the weight ($ x $) and color ($ y $) of each ball in sequence but cannot directly see the belt ($ z $) it came from.</li>
</ul>

<p><em>[Image Caption: Three conveyor belts arranged in a factory setting, with arrows showing the probabilistic transitions between belts. Each belt shows different weight-color relationships - Belt 1 with positive correlation, Belt 2 with negative correlation, Belt 3 with weak correlation]</em></p>

<h2 id="details-on-the-synthetic-data-generation">Details on the Synthetic Data Generation</h2>

<ol>
  <li><strong>Hidden States ($ z_n $)</strong>:
    <ul>
      <li>The conveyor belt in use at time $ n $ (hidden variable).</li>
      <li>Follows a <strong>Markov process</strong>, where:
\(P(z_n | z_{n-1}) = \text{Transition Probability Matrix}\)</li>
      <li>Example transition matrix:
\(\begin{bmatrix}
0.5 &amp; 0.4 &amp; 0.1 \\ 
0.1 &amp; 0.5 &amp; 0.4 \\ 
0.4 &amp; 0.1 &amp; 0.5
\end{bmatrix}\)</li>
    </ul>
  </li>
  <li><strong>Observed Data ($ x, y $)</strong>:
    <ul>
      <li>$ x $: Weight of the ball ($ x \sim \text{Uniform}(1, 10) $).</li>
      <li>$ y $: Color of the ball, determined by the GLM specific to the belt ($ z_n $).</li>
    </ul>
  </li>
  <li><strong>GLMs for Emission Components</strong>:
    <ul>
      <li>Each conveyor belt uses a GLM to model the relationship between weight ($ x $) and color ($ y $):
        <ul>
          <li><strong>Belt 1 (Red)</strong>: $ y_n \sim \mathcal{N}(w_1 \cdot x_n + c_1, \sigma_1^2) $</li>
          <li><strong>Belt 2 (Blue)</strong>: $ y_n \sim \mathcal{N}(w_2 \cdot x_n + c_2, \sigma_2^2) $</li>
          <li><strong>Belt 3 (Neutral)</strong>: $ y_n \sim \mathcal{N}(w_3 \cdot x_n + c_3, \sigma_3^2) $</li>
        </ul>
      </li>
      <li>Their values:
        <ul>
          <li>Belt 1: $ w_1 = 1.0, c_1 = 2.0, \sigma_1 = 1.0 $</li>
          <li>Belt 2: $ w_2 = -0.8, c_2 = -1.0, \sigma_2 = 1.5 $</li>
          <li>Belt 3: $ w_3 = 0.2, c_3 = 0.0, \sigma_3 = 0.8 $</li>
        </ul>
      </li>
    </ul>
  </li>
  <li><strong>Sequence Generation</strong>:
    <ul>
      <li>Start with an initial belt ($ z_1 \sim \pi $, where $ \pi $ is the initial state distribution).</li>
      <li>For each time step $ n $:
        <ol>
          <li>Transition to the next belt ($ z_n $) based on the current belt ($ z_{n-1} $).</li>
          <li>Generate the weight ($ x_n $) from a uniform distribution.</li>
          <li>Generate the color ($ y_n $) using the GLM of the current belt ($ z_n $).</li>
        </ol>
      </li>
    </ul>
  </li>
</ol>

<p>Let’s start by generating and visualizing our data:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="n">jax.numpy</span> <span class="k">as</span> <span class="n">jnp</span>
<span class="kn">import</span> <span class="n">jax.random</span> <span class="k">as</span> <span class="n">jr</span>
<span class="kn">from</span> <span class="n">jax</span> <span class="kn">import</span> <span class="n">vmap</span>
<span class="kn">from</span> <span class="n">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">import</span> <span class="n">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="n">matplotlib.colors</span> <span class="k">as</span> <span class="n">mcolors</span>
<span class="kn">from</span> <span class="n">dynamax.hidden_markov_model</span> <span class="kn">import</span> <span class="n">LinearRegressionHMM</span>
<span class="kn">from</span> <span class="n">dynamax.utils.utils</span> <span class="kn">import</span> <span class="n">find_permutation</span>

<span class="c1"># Generator parameters
</span><span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">])</span>
<span class="n">bias</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">])</span>

<span class="n">trans_mat</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([</span>
    <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">],</span>
    <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">],</span>
    <span class="p">[</span><span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]</span>
<span class="p">])</span>

<span class="n">initial_probs</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">3</span>

<span class="c1"># First, let's see what happens if we ignore the sequential nature
</span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">linspace</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
<span class="n">y_1</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">weights</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">bias</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">scale</span><span class="o">=</span><span class="n">sigma</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">y_2</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">weights</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">bias</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">scale</span><span class="o">=</span><span class="n">sigma</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">y_3</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">weights</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">bias</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">scale</span><span class="o">=</span><span class="n">sigma</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

<span class="n">col_line</span> <span class="o">=</span> <span class="n">mcolors</span><span class="p">.</span><span class="n">LinearSegmentedColormap</span><span class="p">.</span><span class="nf">from_list</span><span class="p">(</span><span class="sh">"</span><span class="s">gradient</span><span class="sh">"</span><span class="p">,</span> <span class="p">[</span><span class="sh">"</span><span class="s">blue</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">red</span><span class="sh">"</span><span class="p">])</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">scatter</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">concatenate</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">]),</span> <span class="n">np</span><span class="p">.</span><span class="nf">concatenate</span><span class="p">([</span><span class="n">y_1</span><span class="p">,</span> <span class="n">y_2</span><span class="p">,</span> <span class="n">y_3</span><span class="p">]),</span> 
           <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="nf">concatenate</span><span class="p">([</span><span class="n">y_1</span><span class="p">,</span> <span class="n">y_2</span><span class="p">,</span> <span class="n">y_3</span><span class="p">]),</span> <span class="n">cmap</span><span class="o">=</span><span class="n">col_line</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="sh">"</span><span class="s">+</span><span class="sh">"</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">colorbar</span><span class="p">(</span><span class="n">ticks</span><span class="o">=</span><span class="p">[])</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">ylabel</span><span class="p">(</span><span class="sh">"</span><span class="s">y (color of ball)</span><span class="sh">"</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">xlabel</span><span class="p">(</span><span class="sh">"</span><span class="s">x (weight)</span><span class="sh">"</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">yticks</span><span class="p">([])</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">title</span><span class="p">(</span><span class="sh">"</span><span class="s">If we did not care for the sequence of ball arrival!</span><span class="sh">"</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div></div>

<p>As you can see, if the balls all came in the same bag at once, there would not be any Markovian process. In that case it just boils down to a mixture! Now let’s make these balls come in sequences:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Set up the sequential data generation
</span><span class="n">num_states</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">emission_dim</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">covariate_dim</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">num_timesteps</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">10</span>

<span class="c1"># Initialize the HMM
</span><span class="n">hmm</span> <span class="o">=</span> <span class="nc">LinearRegressionHMM</span><span class="p">(</span><span class="n">num_states</span><span class="p">,</span> <span class="n">covariate_dim</span><span class="p">,</span> <span class="n">emission_dim</span><span class="p">)</span>

<span class="n">true_params</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">hmm</span><span class="p">.</span><span class="nf">initialize</span><span class="p">(</span>
    <span class="n">jr</span><span class="p">.</span><span class="nc">PRNGKey</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
    <span class="n">initial_probs</span><span class="o">=</span><span class="n">jnp</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">initial_probs</span><span class="p">),</span>
    <span class="n">transition_matrix</span><span class="o">=</span><span class="n">jnp</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">trans_mat</span><span class="p">),</span>
    <span class="n">emission_weights</span><span class="o">=</span><span class="n">jnp</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">weights</span><span class="p">.</span><span class="nf">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>
    <span class="n">emission_biases</span><span class="o">=</span><span class="n">jnp</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">bias</span><span class="p">.</span><span class="nf">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>
    <span class="n">emission_covariances</span><span class="o">=</span><span class="n">jnp</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">sigma</span><span class="p">.</span><span class="nf">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="p">)</span>

<span class="c1"># Create time-varying inputs (sinusoidal weight pattern)
</span><span class="n">inputs</span> <span class="o">=</span> <span class="p">(</span><span class="n">jnp</span><span class="p">.</span><span class="nf">sin</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">jnp</span><span class="p">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">jnp</span><span class="p">.</span><span class="nf">arange</span><span class="p">(</span><span class="n">num_timesteps</span><span class="p">)</span> <span class="o">/</span> <span class="mi">50</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">5</span><span class="p">).</span><span class="nf">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="c1"># Sample from the true model
</span><span class="n">true_states</span><span class="p">,</span> <span class="n">emissions</span> <span class="o">=</span> <span class="n">hmm</span><span class="p">.</span><span class="nf">sample</span><span class="p">(</span><span class="n">true_params</span><span class="p">,</span> <span class="n">jr</span><span class="p">.</span><span class="nc">PRNGKey</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">num_timesteps</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="n">inputs</span><span class="p">)</span>

<span class="c1"># Generate multiple batches for training
</span><span class="n">batch_inputs</span> <span class="o">=</span> <span class="n">jnp</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">num_timesteps</span><span class="p">,</span> <span class="n">covariate_dim</span><span class="p">)))</span>
<span class="n">batch_true_states</span><span class="p">,</span> <span class="n">batch_emissions</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">batch_size</span><span class="p">):</span>
    <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">hmm</span><span class="p">.</span><span class="nf">sample</span><span class="p">(</span><span class="n">true_params</span><span class="p">,</span> <span class="n">jr</span><span class="p">.</span><span class="nc">PRNGKey</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">10</span><span class="p">),</span> <span class="n">num_timesteps</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="n">batch_inputs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">batch_true_states</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="n">batch_emissions</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
<span class="n">batch_true_states</span> <span class="o">=</span> <span class="n">jnp</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">batch_true_states</span><span class="p">)</span>
<span class="n">batch_emissions</span> <span class="o">=</span> <span class="n">jnp</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">batch_emissions</span><span class="p">)</span>
</code></pre></div></div>

<p>Let’s visualize the sequential data:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">plt</span><span class="p">.</span><span class="nf">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">col_line</span> <span class="o">=</span> <span class="n">mcolors</span><span class="p">.</span><span class="n">LinearSegmentedColormap</span><span class="p">.</span><span class="nf">from_list</span><span class="p">(</span><span class="sh">"</span><span class="s">gradient</span><span class="sh">"</span><span class="p">,</span> <span class="p">[</span><span class="sh">"</span><span class="s">blue</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">red</span><span class="sh">"</span><span class="p">])</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">scatter</span><span class="p">(</span><span class="n">jnp</span><span class="p">.</span><span class="nf">arange</span><span class="p">(</span><span class="n">num_timesteps</span><span class="p">),</span> <span class="n">emissions</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">emissions</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">col_line</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="sh">'</span><span class="s">o</span><span class="sh">'</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">colorbar</span><span class="p">()</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">ylabel</span><span class="p">(</span><span class="sh">"</span><span class="s">Emission Color</span><span class="sh">"</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">xlabel</span><span class="p">(</span><span class="sh">"</span><span class="s">Time</span><span class="sh">"</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">title</span><span class="p">(</span><span class="sh">"</span><span class="s">If you were given this, could you tell which belt each point came from?</span><span class="sh">"</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>

<span class="c1"># Plot the inputs, emissions, and true states
</span><span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">gridspec_kw</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">height_ratios</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">]},</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

<span class="n">em_max</span> <span class="o">=</span> <span class="n">emissions</span><span class="p">.</span><span class="nf">max</span><span class="p">()</span> <span class="o">+</span> <span class="mi">2</span>
<span class="n">em_min</span> <span class="o">=</span> <span class="n">emissions</span><span class="p">.</span><span class="nf">min</span><span class="p">()</span> <span class="o">-</span> <span class="mi">2</span>

<span class="c1"># Plot inputs (weights)
</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">plot</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="sh">'</span><span class="s">k-</span><span class="sh">'</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="sh">'</span><span class="s">.</span><span class="sh">'</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_timesteps</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">"</span><span class="s">weight</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># Plot emissions with true states as background
</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">imshow</span><span class="p">(</span><span class="n">true_states</span><span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="p">:],</span>
              <span class="n">extent</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_timesteps</span><span class="p">,</span> <span class="n">em_min</span><span class="p">,</span> <span class="n">em_max</span><span class="p">),</span>
              <span class="n">aspect</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">,</span>
              <span class="n">cmap</span><span class="o">=</span><span class="sh">"</span><span class="s">Grays</span><span class="sh">"</span><span class="p">,</span>
              <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">plot</span><span class="p">(</span><span class="n">emissions</span><span class="p">,</span> <span class="sh">'</span><span class="s">k--</span><span class="sh">'</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="sh">'</span><span class="s">.</span><span class="sh">'</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">scatter</span><span class="p">(</span><span class="n">jnp</span><span class="p">.</span><span class="nf">arange</span><span class="p">(</span><span class="n">num_timesteps</span><span class="p">),</span> <span class="n">emissions</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">emissions</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">col_line</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="sh">'</span><span class="s">o</span><span class="sh">'</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_timesteps</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">set_ylim</span><span class="p">(</span><span class="n">em_min</span><span class="p">,</span> <span class="n">em_max</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">"</span><span class="s">emissions (color)</span><span class="sh">"</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">set_xlabel</span><span class="p">(</span><span class="sh">"</span><span class="s">Time</span><span class="sh">"</span><span class="p">)</span>

<span class="n">plt</span><span class="p">.</span><span class="nf">suptitle</span><span class="p">(</span><span class="sh">"</span><span class="s">True Simulated Data</span><span class="sh">"</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div></div>

<p><strong>Can you tell the belts apart now? 🔎</strong></p>

<h2 id="glm-hmm-specification-switching-linear-regression">GLM-HMM Specification (Switching Linear Regression)</h2>

<p><strong>1. Emissions (GLM for Observed Data)</strong>:</p>
<ul>
  <li>The observed data $ y_t $ at time $ t $ is modeled as a Gaussian distribution:
\(y_t \mid x_t, z_t = k \sim \mathcal{N}(x_t \cdot w_k + c_k, \sigma_k^2)\)
where:
    <ul>
      <li>$ z_t \in {1, 2, \dots, K} $: Discrete latent state (which conveyor belt is active at time $ t $).</li>
      <li>$ x_t $: Input feature (ball weight).</li>
      <li>$ w_k $: Weight for the linear relationship in state $ k $.</li>
      <li>$ c_k $: Bias (intercept) for state $ k $.</li>
      <li>$ \sigma_k^2 $: Variance of the Gaussian noise for state $ k $.</li>
    </ul>
  </li>
</ul>

<p><strong>2. Latent States (Markov Process)</strong>:</p>
<ul>
  <li>The discrete latent states $ z_t $ follow a <strong>Markov process</strong>:
\(z_1 \sim \pi, \quad z_{t+1} \mid z_t \sim P_{z_t}\)
where:
    <ul>
      <li>$ \pi $: Initial state distribution.</li>
      <li>$ P_{z_t} $: Transition probability matrix describing transitions between states.</li>
    </ul>
  </li>
</ul>

<p><strong>Priors on Model Parameters</strong>:
\(\pi \sim \text{Dirichlet}(\alpha_{\pi})\)
\(P_{z_t} \sim \text{Dirichlet}(\alpha_P)\)
\(w_k \sim \mathcal{N}(0, 1), \quad c_k \sim \mathcal{N}(0, 1) \quad \text{for } k = 1, \dots, K\)
\(\sigma_k \sim |\mathcal{N}(0, 1)| \quad \text{for } k = 1, \dots, K\)</p>

<p><strong>Likelihood</strong>:</p>

<p>For each observed $ y_t $:</p>
<ol>
  <li>Conditioned on the hidden state $ z_t $, the likelihood is:
\(P(y_t \mid x_t, z_t = k, w_k, c_k, \sigma_k) = \mathcal{N}(y_t \mid x_t \cdot w_k + c_k, \sigma_k^2)\)</li>
  <li>The full likelihood marginalizes over all possible hidden states:
\(P(y_t \mid x_t, \pi, P, \{w_k, c_k, \sigma_k\}_{k=1}^K) = \sum_{k=1}^K P(z_t = k \mid z_{t-1}, P) \cdot \mathcal{N}(y_t \mid x_t \cdot w_k + c_k, \sigma_k^2)\)</li>
</ol>

<p><strong>Posterior</strong>:</p>

<p>Using Bayes’ theorem, the posterior is:
\(P(\pi, P, \{w_k, c_k, \sigma_k\}_{k=1}^K \mid y_{1:T}, x_{1:T}) \propto P(y_{1:T} \mid x_{1:T}, \pi, P, \{w_k, c_k, \sigma_k\}_{k=1}^K) \cdot P(\pi) \cdot P(P) \cdot \prod_{k=1}^K P(w_k) P(c_k) P(\sigma_k)\)</p>

<h2 id="how-to-solve-this-complex-model-">How to Solve This Complex Model? 😱</h2>

<p>We can solve it the same way we have been solving our models. However, the <strong>Markovian nature</strong> of the model introduces <strong>dependencies</strong> between the observations, making it more complex to solve than the previous models. Making full Bayesian inference computationally <strong>VERY</strong> expensive.</p>

<p>For practical purposes, we’ll use the <strong>Expectation-Maximization (EM)</strong> algorithm with optimizations:</p>

<ol>
  <li><strong>Parameter Estimation</strong>: Estimate parameters by maximizing the marginal likelihood</li>
  <li><strong>Forward-Backward Algorithm</strong>: Efficiently compute state probabilities</li>
  <li><strong>Viterbi Algorithm</strong>: Find the most likely sequence of states</li>
</ol>

<p><strong>Let’s go and train it!</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Initialize and fit the GLM-HMM
</span><span class="n">test_params</span><span class="p">,</span> <span class="n">param_props</span> <span class="o">=</span> <span class="n">hmm</span><span class="p">.</span><span class="nf">initialize</span><span class="p">(</span><span class="n">jr</span><span class="p">.</span><span class="nc">PRNGKey</span><span class="p">(</span><span class="mi">42</span><span class="p">))</span>

<span class="c1"># Fit the model using EM
</span><span class="n">test_params</span><span class="p">,</span> <span class="n">lps</span> <span class="o">=</span> <span class="n">hmm</span><span class="p">.</span><span class="nf">fit_em</span><span class="p">(</span><span class="n">test_params</span><span class="p">,</span> <span class="n">param_props</span><span class="p">,</span> <span class="n">batch_emissions</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="n">batch_inputs</span><span class="p">)</span>

<span class="c1"># Plot training progress
</span><span class="n">plt</span><span class="p">.</span><span class="nf">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">lps</span><span class="p">,</span> <span class="sh">"</span><span class="s">k--</span><span class="sh">"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sh">'</span><span class="s">EM Training</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">xlabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Epoch</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Log Probability</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">title</span><span class="p">(</span><span class="sh">"</span><span class="s">GLM-HMM Training Progress</span><span class="sh">"</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div></div>

<p>Now let’s see how well our model recovered the true states:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">plot_states</span><span class="p">(</span><span class="n">true_states</span><span class="p">,</span> <span class="n">most_likely_states</span><span class="p">,</span> <span class="n">emissions</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="sh">"</span><span class="s">Did the HMM get it right?</span><span class="sh">"</span><span class="p">):</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">gridspec_kw</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">height_ratios</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]},</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">states</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">([</span><span class="n">true_states</span><span class="p">,</span> <span class="n">most_likely_states</span><span class="p">]):</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="nf">imshow</span><span class="p">(</span><span class="n">states</span><span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="p">:],</span>
                    <span class="n">extent</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_timesteps</span><span class="p">,</span> <span class="n">em_min</span><span class="p">,</span> <span class="n">em_max</span><span class="p">),</span>
                    <span class="n">aspect</span><span class="o">=</span><span class="sh">"</span><span class="s">auto</span><span class="sh">"</span><span class="p">,</span>
                    <span class="n">cmap</span><span class="o">=</span><span class="sh">"</span><span class="s">binary</span><span class="sh">"</span><span class="p">,</span>
                    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="nf">plot</span><span class="p">(</span><span class="n">emissions</span><span class="p">,</span> <span class="sh">'</span><span class="s">k-</span><span class="sh">'</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="sh">'</span><span class="s">.</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="nf">scatter</span><span class="p">(</span><span class="n">jnp</span><span class="p">.</span><span class="nf">arange</span><span class="p">(</span><span class="n">num_timesteps</span><span class="p">),</span> <span class="n">emissions</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">emissions</span><span class="p">,</span> 
                      <span class="n">cmap</span><span class="o">=</span><span class="n">col_line</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="sh">'</span><span class="s">o</span><span class="sh">'</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="nf">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_timesteps</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="nf">set_ylim</span><span class="p">(</span><span class="n">em_min</span><span class="p">,</span> <span class="n">em_max</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">"</span><span class="s">emissions</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="nf">set_xlabel</span><span class="p">(</span><span class="sh">"</span><span class="s">time</span><span class="sh">"</span><span class="p">)</span>

    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">"</span><span class="s">true states</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">"</span><span class="s">inferred states</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="nf">suptitle</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>

<span class="c1"># Compute the most likely states
</span><span class="n">most_likely_states</span> <span class="o">=</span> <span class="n">hmm</span><span class="p">.</span><span class="nf">most_likely_states</span><span class="p">(</span><span class="n">test_params</span><span class="p">,</span> <span class="n">emissions</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="n">inputs</span><span class="p">)</span>
<span class="nf">plot_states</span><span class="p">(</span><span class="n">true_states</span><span class="p">,</span> <span class="n">most_likely_states</span><span class="p">,</span> <span class="n">emissions</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div></div>

<p>It looks pretty bad, doesn’t it? But look closer - this is our old friend <strong>LABEL SWITCHING</strong>! Let’s align them:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">permutation</span> <span class="o">=</span> <span class="nf">find_permutation</span><span class="p">(</span><span class="n">true_states</span><span class="p">,</span> <span class="n">most_likely_states</span><span class="p">)</span>
<span class="n">remapped_states</span> <span class="o">=</span> <span class="n">permutation</span><span class="p">[</span><span class="n">true_states</span><span class="p">]</span>
<span class="nf">plot_states</span><span class="p">(</span><span class="n">remapped_states</span><span class="p">,</span> <span class="n">most_likely_states</span><span class="p">,</span> <span class="n">emissions</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="sh">"</span><span class="s">How about now after alignment?</span><span class="sh">"</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div></div>

<p>Much better!</p>

<p><strong>QUIZ</strong>: Why does it get certain time points exceptionally wrong? (Even after label switching, why is it extra difficult?) Hint: Look at the input closely.</p>

<h2 id="parameter-recovery-analysis">Parameter Recovery Analysis</h2>

<p>Let’s examine how well we recovered the original parameters:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">seaborn</span> <span class="k">as</span> <span class="n">sns</span>
<span class="kn">import</span> <span class="n">pandas</span> <span class="k">as</span> <span class="n">pd</span>

<span class="k">def</span> <span class="nf">get_color_gradient</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">color1</span><span class="o">=</span><span class="sh">"</span><span class="s">red</span><span class="sh">"</span><span class="p">,</span> <span class="n">color2</span><span class="o">=</span><span class="sh">"</span><span class="s">blue</span><span class="sh">"</span><span class="p">):</span>
    <span class="n">cmap</span> <span class="o">=</span> <span class="n">mcolors</span><span class="p">.</span><span class="n">LinearSegmentedColormap</span><span class="p">.</span><span class="nf">from_list</span><span class="p">(</span><span class="sh">"</span><span class="s">gradient</span><span class="sh">"</span><span class="p">,</span> <span class="p">[</span><span class="n">color1</span><span class="p">,</span> <span class="n">color2</span><span class="p">])</span>
    <span class="k">return</span> <span class="p">[</span><span class="nf">cmap</span><span class="p">(</span><span class="n">i</span> <span class="o">/</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>

<span class="c1"># Extract recovered parameters
</span><span class="n">t_tr</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">test_params</span><span class="p">.</span><span class="n">transitions</span><span class="p">.</span><span class="n">transition_matrix</span><span class="p">)</span>
<span class="n">t_init</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">test_params</span><span class="p">.</span><span class="n">initial</span><span class="p">.</span><span class="n">probs</span><span class="p">).</span><span class="nf">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">t_weights</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">test_params</span><span class="p">.</span><span class="n">emissions</span><span class="p">.</span><span class="n">weights</span><span class="p">).</span><span class="nf">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">t_covs</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">test_params</span><span class="p">.</span><span class="n">emissions</span><span class="p">.</span><span class="n">covs</span><span class="p">).</span><span class="nf">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">t_bias</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">test_params</span><span class="p">.</span><span class="n">emissions</span><span class="p">.</span><span class="n">biases</span><span class="p">).</span><span class="nf">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Compare transition matrices
</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

<span class="c1"># Apply permutation to true parameters for comparison
</span><span class="n">true_trans_aligned</span> <span class="o">=</span> <span class="n">trans_mat</span><span class="p">[</span><span class="n">permutation</span><span class="p">,</span> <span class="p">:][:,</span> <span class="n">permutation</span><span class="p">]</span>

<span class="n">sns</span><span class="p">.</span><span class="nf">heatmap</span><span class="p">(</span><span class="n">true_trans_aligned</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="sh">"</span><span class="s">Greens</span><span class="sh">"</span><span class="p">,</span> <span class="n">annot</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">cbar</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">"</span><span class="s">True Transition Matrix</span><span class="sh">"</span><span class="p">)</span>

<span class="n">sns</span><span class="p">.</span><span class="nf">heatmap</span><span class="p">(</span><span class="n">t_tr</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="sh">"</span><span class="s">Greens</span><span class="sh">"</span><span class="p">,</span> <span class="n">annot</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">cbar</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">"</span><span class="s">Recovered Transition Matrix</span><span class="sh">"</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>

<span class="c1"># Compare GLM parameters
</span><span class="k">def</span> <span class="nf">plot_param_comparison</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">r_param</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">ylabel</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.35</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

    <span class="n">states</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nf">len</span><span class="p">(</span><span class="n">param</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">arange</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">param</span><span class="p">))</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="nf">get_color_gradient</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    
    <span class="n">ax</span><span class="p">.</span><span class="nf">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sh">'</span><span class="s">Generator</span><span class="sh">'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">.</span><span class="nf">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">r_param</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sh">'</span><span class="s">Recovered</span><span class="sh">'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">.</span><span class="nf">set_xticks</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="sa">f</span><span class="sh">'</span><span class="s">State </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="sh">'</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">states</span><span class="p">])</span>
    <span class="n">ax</span><span class="p">.</span><span class="nf">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">.</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">.</span><span class="nf">set_xlabel</span><span class="p">(</span><span class="sh">'</span><span class="s">States</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">.</span><span class="nf">legend</span><span class="p">()</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="c1"># Plot each parameter comparison with permutation applied
</span><span class="nf">plot_param_comparison</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="n">permutation</span><span class="p">],</span> <span class="n">t_weights</span><span class="p">,</span> <span class="sh">"</span><span class="s">Weights Comparison</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">Weight Value</span><span class="sh">"</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="nf">plot_param_comparison</span><span class="p">(</span><span class="n">bias</span><span class="p">[</span><span class="n">permutation</span><span class="p">],</span> <span class="n">t_bias</span><span class="p">,</span> <span class="sh">"</span><span class="s">Bias Comparison</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">Bias Value</span><span class="sh">"</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="nf">plot_param_comparison</span><span class="p">(</span><span class="n">sigma</span><span class="p">[</span><span class="n">permutation</span><span class="p">],</span> <span class="n">t_covs</span><span class="p">,</span> <span class="sh">"</span><span class="s">Sigma Comparison</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">Sigma Value</span><span class="sh">"</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="nf">plot_param_comparison</span><span class="p">(</span><span class="n">initial_probs</span><span class="p">[</span><span class="n">permutation</span><span class="p">],</span> <span class="n">t_init</span><span class="p">,</span> <span class="sh">"</span><span class="s">Initial Probabilities Comparison</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">Probability</span><span class="sh">"</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

<span class="n">plt</span><span class="p">.</span><span class="nf">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div></div>

<p><strong>Considering these are point estimates from only 10 batches, the results are pretty good!</strong></p>

<h2 id="final-thoughts">Final Thoughts</h2>

<p>Bayesian modeling is both an art and a science. The art lies in choosing appropriate priors and model structures that capture the essence of your problem. The science lies in the rigorous mathematical framework that ensures coherent uncertainty quantification and principled inference.</p>

<p><strong>Thank you for attending my Ted Talk! 🙇🎤</strong></p>

        </div>
      </div>
      
      <footer class="footer">
        <div class="footer__cp">© 2025</div>
      </footer>

      <!-- 1) Your MathJax configuration -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    "HTML-CSS": { availableFonts: ["TeX"] },
    tex2jax: {
      inlineMath: [['$','$'],['\\(','\\)']],
      displayMath: [['$$','$$'],['\\[','\\]']]
    },
    TeX: {
      extensions: ["AMSmath.js","AMSsymbols.js","color.js"],
      equationNumbers: { autoNumber: "AMS" }
    },
    showProcessingMessages: false,
    messageStyle: "none",
    imageFont: null,
    "AssistiveMML": { disabled: true }
  });
</script>

<!-- 2) Then load the MathJax engine -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS_HTML"></script><script>
  if (!(window.doNotTrack === "1" || navigator.doNotTrack === "1" || navigator.doNotTrack === "yes" || navigator.msDoNotTrack === "1")) {
    (function() {
      var gtagScript = document.createElement('script');
      gtagScript.async = true;
      gtagScript.src = 'https://www.googletagmanager.com/gtag/js?id=G-XWEJZKE72S';
      document.head.appendChild(gtagScript);
  
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-XWEJZKE72S');
    })();
  }
</script>

    
    </main>

  </body>

</html>
